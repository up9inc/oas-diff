<!DOCTYPE html>
<html lang="en">

<head>
    <title></title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <style>
        .summary {
            padding-bottom: 0.5em;
        }

        .summary span {
            margin-left: 1em;
        }

        .content {
            padding: 1em 1em 0;
        }

        .card-header.bg-warning {
            cursor: pointer;
        }

        .card-header .resp {
            margin-left: 2em;
            font-size: smaller;
            opacity: 0.5;
        }

        .card-header .badge {
            margin: 0 0.25em;
            font-weight: normal;
        }
    </style>
</head>

<body>

    <div class="content">
        <ul class="list-group">
            <li class="list-group-item">
                <b></b>
                <h5 class="text-center" style="color:#393085"><b> </b></h5>
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Report generated on: {{.Status.StartTime}}</th>
                            <th class="small float">Display:
                                <label class="text-success"><input type="checkbox" checked="checked"
                                        data-target="created">
                                    Created</label>
                                <label class="text-warning"><input type="checkbox" checked="checked"
                                        data-target="updated">
                                    Updated</label>
                                <label class="text-danger"><input type="checkbox" checked="checked"
                                        data-target="deleted">
                                    Deleted</label>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Base File</td>
                            <td>{{.Status.BaseFilePath}}</td>

                        </tr>
                        <tr>
                            <td>Second File</td>
                            <td>{{.Status.SecondFilePath}}</td>

                        </tr>
                        <tr>
                            <td>Execution Time</td>
                            <td>{{.Status.ExecutionTime}}</td>

                        </tr>
                        <tr>
                            <td>Flags</td>
                            <td>
                                {{if .Status.ExecutionFlags.Loose}}
                                --loose
                                {{end}}
                                {{if .Status.ExecutionFlags.IncludeFilePath}}
                                --include-file-path
                                {{end}}
                                {{if .Status.ExecutionFlags.ExcludeDescriptions}}
                                --exclude-descriptions
                                {{end}}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </li>
        </ul>
    </div>

    <div id="content" class="content"></div>

</body>
<script src="https://code.jquery.com/jquery-3.4.1.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
    integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
    crossorigin="anonymous"></script>
<script>
    const changelog = '{{.Changelog}}';
    console.log(changelog)

    const pathChangelogList = '{{.PathChangelogList}}';
    console.log(pathChangelogList)

    const pathChangelogMap = '{{.PathChangelogMap}}';
    console.log(pathChangelogMap)

    function revisedRandId() {
        return 'i_' + Math.round(Math.random() * 1000);
    }

    function path_detail_cards(data, container) {
        for (let n = 0; n < data.length; n++) {
            let ditem = data[n];
            const type = ditem["changelog"]["type"]
            const endpoint = ditem["endpoint"]
            const method = ditem["operation"].toUpperCase()
            const path = JSON.parse(JSON.stringify(ditem["changelog"]["path"]));

            let card = $("<div class='card'></div>");
            let cid = revisedRandId();
            let chdr = $("<div class='card-header' data-toggle='collapse' role='button' aria-expanded='false'></div>");
            chdr.attr('href', '#' + cid);
            chdr.attr('aria-controls', cid);

            chdr.append(`<span class='float-left badge badge-light text-info'>${method}</span> ${endpoint}`);
            //chdr.append(`<span class="resp">HTTP response</span>`);

            /*                 const criteria = JSON.parse(JSON.stringify(lbl));
                            const standard = criteria.shift();
                            chdr.append(standard[2] + ' <span class="resp">HTTP ' + standard[1] + ' ' + lbl[3] + ' response</span>'); */

            path.shift()
            path.shift()
            while (path.length) {
                chdr.append(`<span class="resp">${path.shift()}</span>`);
            }


            card.append(chdr);
            let match_hint;

            if (type === 'create') {
                card.addClass("created");
                chdr.addClass("bg-success");
                chdr.addClass("text-light");
                match_hint = "only exists in second";
            } else if (type === 'update') {
                card.addClass("updated");
                chdr.addClass("bg-warning");
                chdr.addClass("text-dark");
                // TODO: What to display when updated?
                match_hint = "";
            } else if (type === 'delete') {
                card.addClass("deleted");
                chdr.addClass("bg-danger");
                chdr.addClass("text-light");
                match_hint = "missing in second";
            }

            // type
            chdr.append(`<span class='float-right badge badge-light text-info'>${type}</span>`);
            // type source file            
            chdr.append($("<span class='float-right badge badge-light text-success'></span>").append(match_hint));

            let cbody = $("<div class='card-body collapse small' id='" + cid + "'></div>");

            if (ditem.info) {
                for (let ni = 0; ni < ditem.info.length; ni++) {
                    chdr.append("<li>" + ditem.info[ni] + "</li>")
                }
            }

            /*                             if (ditem['diff'].length) {
                                            path_detail_cards(ditem['diff'], cbody);
                                        } */
            card.append(cbody);

            container.append(card);

        }

        let summarySpan = $("<div class='small summary'>Summary:</div>");
        summarySpan.append(`<span class='text-info'>${data.length} changes</span>`)
        container.prepend(summarySpan);
    }

    function path_detail_cards2(data, container) {
        for (const [key, value] of Object.entries(data)) {
            console.log(value);
        }


        for (let n = 0; n < data.length; n++) {
            let ditem = data[n];
            const type = ditem["changelog"]["type"]
            const endpoint = ditem["endpoint"]
            const method = ditem["operation"].toUpperCase()
            const path = JSON.parse(JSON.stringify(ditem["changelog"]["path"]));

            let card = $("<div class='card'></div>");
            let cid = revisedRandId();
            let chdr = $("<div class='card-header' data-toggle='collapse' role='button' aria-expanded='false'></div>");
            chdr.attr('href', '#' + cid);
            chdr.attr('aria-controls', cid);

            chdr.append(`<span class='float-left badge badge-light text-info'>${method}</span> ${endpoint}`);
            //chdr.append(`<span class="resp">HTTP response</span>`);

            /*                 const criteria = JSON.parse(JSON.stringify(lbl));
                            const standard = criteria.shift();
                            chdr.append(standard[2] + ' <span class="resp">HTTP ' + standard[1] + ' ' + lbl[3] + ' response</span>'); */

            path.shift()
            path.shift()
            while (path.length) {
                chdr.append(`<span class="resp">${path.shift()}</span>`);
            }


            card.append(chdr);
            let match_hint;

            if (type === 'create') {
                card.addClass("created");
                chdr.addClass("bg-success");
                chdr.addClass("text-light");
                match_hint = "only exists in second";
            } else if (type === 'update') {
                card.addClass("updated");
                chdr.addClass("bg-warning");
                chdr.addClass("text-dark");
                // TODO: What to display when updated?
                match_hint = "";
            } else if (type === 'delete') {
                card.addClass("deleted");
                chdr.addClass("bg-danger");
                chdr.addClass("text-light");
                match_hint = "missing in second";
            }

            // type
            chdr.append(`<span class='float-right badge badge-light text-info'>${type}</span>`);
            // type source file            
            chdr.append($("<span class='float-right badge badge-light text-success'></span>").append(match_hint));

            let cbody = $("<div class='card-body collapse small' id='" + cid + "'></div>");

            if (ditem.info) {
                for (let ni = 0; ni < ditem.info.length; ni++) {
                    chdr.append("<li>" + ditem.info[ni] + "</li>")
                }
            }

            /*                             if (ditem['diff'].length) {
                                            path_detail_cards(ditem['diff'], cbody);
                                        } */
            card.append(cbody);

            container.append(card);

        }

        let summarySpan = $("<div class='small summary'>Summary:</div>");
        summarySpan.append(`<span class='text-info'>${data.length} changes</span>`)
        container.prepend(summarySpan);
    }

    //path_detail_cards(pathChangelog, $("#content"));
    //path_detail_cards2(pathChangelog2, $("#content"));

    $("input").change(function () {
        let item = $(this);
        let blocks = $(".card." + item.data('target'));
        if (item.prop('checked')) {
            blocks.show();
        } else {
            blocks.hide();
        }
    });
</script>

</html>